# Efficient Detection of Split Personalities in Malware

## 摘要

恶意程序是很多互联网安全威胁的主要原因. 为了对付每天都会发现的成百上千的新恶意软件, 安全公司与研究人员一依靠自动化工具提取恶意软件的行为特征. 与此同时恶意软件作者也想方设法的防止被检测.恶意软件通常也具备检查出虚拟测试环境的能力. 这时恶意软件会改变行为模式或者直接崩溃, 和在正常系统里运行相比, 恶意软件在虚拟测试环境中会表现出不同的行为.

一种透明检测平台(Ether, Cobra)的出现使得恶意软件更难以检测出测试环境, 另一些提出了使用某些技术去识别并通过恶意软件的检测. 两者都成功检测出恶意软件并使恶意软件的防范机制失效. 然而两者都导致了高性能开销, 这使得它们不适合做大批量的恶意软件分析.

这份论文中, 我们将介绍一种技术可以高效检查出恶意软件在测试环境中的异样行为. 原理很简单:　比较在测试环境中与参考机器上的样品行为．　然而一个强大有效的比较实现是有困难的．　我们将记录恶意软件与操作系统的交互并将此作为测试环境中给样品的回复．我们将通过实验演示，通过这个方法，可以有效检测出具有很强防范机制的恶意软件．

## 介绍

与日俱增的恶意软件数目使安全公司与研究人员投入更大的精力用以研发自动化的恶意软件检测工具, 这些工具通常在受限环境中(沙箱)运行未知软件, 监测未知程序的行为. 根据监测到的结果, 研究人员能够评估恶意软件的威胁程度以及制定相应防范策略. 当然恶意软件作者也会编写相应代码以防范被检测出来. 通过隐藏在自动检测系统中, 恶意软件可以运行更长一段时间.

为了阻挠自动侦察, 恶意软件作者开发出了很多方法去检查恶意软件分析工具和沙箱. 当恶意软件发现存在恶意软件分析工具, 通常会不执行恶意功能或是直接退出. 恶意软件依靠恶意软件分析工具的目标类型实现这类检测. 一种检测来自运行环境的输入以确定是否存在分析工具. 通常这类检查查找文件, 注册表, 或是分析工具进程. 第二种检测检查测试环境与真实环境的不同特征. 对于这些检测, CPU指令的细小变化或是定时属性都是恶意软件用来确定运行环境的因素.

要解决"反检测恶意软件", 研究人员探索出两种途径. 一种专注与开发更难以察觉的分析平台, Cobra是最早的透明分析系统之一. 这种系统在检测中执行动态的代码转换, 也就是说每段代码块在执行前被反编译并检查. 在这个过程中, 每条指令都会被Cobra检查并替换为一个安全的版本, 这被称为透明注入(stealth implant). 之后研究人员提出了Ether, 一个利用硬件虚拟化以保持对恶意软件不可见的系统.

Cobra和Ether都展示出了它们难以被现有的恶意软件所发现. 然而, 它们也导致了不可忽视的性能负担, 特别是在执行细粒度(fine-grained)分析时. 不幸的是, 对于Anubis所生产的分析工具以及类似系统, 要得到全面的分析报告, 这样级别的分析是必须的. 这是因为这些系统至少需要检查从额外的Windows API库函数到系统调用的所有参数, 而且在运行时还经常追踪额外的信息. 影响性能的主要原因是Cobra和Ether通过进程执行单个指令. 有趣的是, Ether的作者指出他们的细粒度(fine-grained)分析"不是用来做实时分析的", 于此同时Cobra的作者指出他们工具的表现"在交互分析局限之内." 鉴于这些局限, 这些系统不适合用来自动处理大容量的恶意软件分析. 例如, Anubis每天接受到几千个恶意软件样本, 而这个数字对于商业反恶意软件公司可能更大.

第二类途径是检测恶意软件在不同环境下的行为异常. 最近, 研究人员提出了一个工具, 用以比较恶意软件在正常系统中与虚拟分析环境中的运行情况. 运行结果的偏差被认为是由恶意软件的检查机制导致的. 这个理论中的基本想法是很有吸引力的, 它保证了一种通用的恶意软件检测机制, 即恶意软件在不同运行环境下的行为异常. 然而在实践中还有一些需要解决的问题, 有效的执行异常检测是很重要的, 而且任何异常应该仅仅由恶意软件自己的检测机制所引发. 不幸的是上述的工具难以解决这两个问题. 首先, 这个个工具使用Ether产生参考轨迹, 这导致了难以接受的性能损耗. 其次, 恶意软件样本只简单地执行了两次, 一次在分析环境中一次在参考环境中. 然而正如我们的实验所演示的那样, 即使没有反分析检测, 执行恶意软件样本也会导致不同的运行结果. 因此, 两次执行追踪的不同并不是检测是否为恶意软件的有效指标.

这篇论文中我们提出一种有效可靠的检测工具, 它能够检测在不同环境下行为不同的恶意软件, 即那些"人格分裂"的恶意软件. 为了执行检测, 我们利用基本的一个想法, 在给定相同输入的情况下, 程序在测试环境中与参考环境中的运行结果应一致. 更进一步说, 我们在参考环境里用内核驱动有效记录下那些在分析环境中被恶意软件样本所执行的系统调用(和它们的参数)的轨迹. 这份系统调用日志包含了输出参数(被程序输出和被系统接收的值)和输入参数(由系统提供并被程序接收的值). 下一步在测试环境中再进行一次. 我们的分析环境是修改版的Anubis, 这是一个系统模拟器Qemu的扩展. 根据系统调用日志, 我们可以提供与参考系统相同的输入参数. 这允许我们在给出相同信息的情况下, 检查系统输出(与它们的参数)是否与期望的相符. 由于输入是相同的, 因此我们期望结果的偏差是由恶意软件的检查机制所导致的, 并因此导致了恶意软件执行了不同的流程.

我们的Windows进程回放设备是这个分析环境的核心组件, 它功能全面并支持那些需要特殊处理的功能, 例如多线程, 存储器映射文件, 和延迟系统调用. 这对于处理复杂的Windows内部进程并使系统在面对真正的恶意软件时能够正常工作是必不可少的. 我们的实验结果显示这样该系统能够识别多种不同的反分析检测. 此外, 系统可以成功的执行(回放)不包含检测的程序, 而且能够检测出带有反分析检测的恶意软件.

这篇论文的主要价值如下:

- 我们提出了一种可信有效的方法去检测"人格分裂"的恶意软件. 通过比较分析系统环境下与参考环境下程序运行的系统调用跟踪记录, 我们可以检测出带有反分析能力的恶意软件.
- 我们完善了一种对Windows进程的全面回放设备, 这使得我们在分析环境下与参考环境下能以相同的输入执行程序.
- 我们演示了我们的工具可以检测出带有反分析能力的恶意软件, 甚至是那些能够逃避Anubis的恶意软件.